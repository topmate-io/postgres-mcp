apiVersion: apps/v1
kind: Deployment
metadata:
  name: db-mcp-server
  namespace: postgres-mcp
  labels:
    app: db-mcp-server
    app.kubernetes.io/name: topmate-bi-mcp
    app.kubernetes.io/part-of: topmate-mcp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db-mcp-server
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      annotations:
        karpenter.sh/do-not-disrupt: "true"
      labels:
        app: db-mcp-server
        app.kubernetes.io/name: topmate-bi-mcp
    spec:
      serviceAccountName: postgres-mcp-sa
      containers:
        - name: topmate-bi-mcp
          image: __AWS_ACCOUNT_ID__.dkr.ecr.ap-south-1.amazonaws.com/topmate-db-mcp-server:__IMAGE_TAG__
          ports:
            - containerPort: 9000
              protocol: TCP
          env:
            # --- Server ---
            - name: PORT
              value: "9000"
            - name: TRANSPORT
              value: "sse"
            - name: LOG_LEVEL
              value: "INFO"
            # --- LLM Provider (switch via this env var) ---
            - name: LLM_PROVIDER
              value: "openrouter"
            - name: ENABLE_CLARIFICATION
              value: "true"
            # --- Postgres MCP (primary: topmate-db-prod-replica) ---
            - name: POSTGRES_MCP_URL
              value: "http://postgres-mcp-service.postgres-mcp.svc:80/postgres-mcp"
            - name: POSTGRES_MCP_TRANSPORT
              value: "sse"
            - name: POSTGRES_MCP_TIMEOUT
              value: "60"
            # --- Additional databases (optional - set URLs when postgres-mcp pods are deployed for each) ---
            # - name: POSTGRES_MCP_KINGSMEAD_URL
            #   value: "http://kingsmead-mcp-service.postgres-mcp.svc:80/kingsmead-mcp"
            # - name: POSTGRES_MCP_AUTODM_URL
            #   value: "http://autodm-mcp-service.postgres-mcp.svc:80/autodm-mcp"
            # - name: POSTGRES_MCP_WEBSITE_BUILDER_URL
            #   value: "http://website-builder-mcp-service.postgres-mcp.svc:80/website-builder-mcp"
            # --- Logic Hub ---
            - name: TOPMATE_LOGIC_HUB_BASE_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-mcp-secrets
                  key: logic-hub-url
            - name: TOPMATE_LOGIC_HUB_API_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-mcp-secrets
                  key: logic-hub-api-key
            # --- GitHub App Auth ---
            - name: GITHUB_APP_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: github-app-id
                  optional: true
            - name: GITHUB_APP_INSTALLATION_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: github-app-installation-id
                  optional: true
            - name: GITHUB_APP_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: github-app-private-key
                  optional: true
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: github-token
                  optional: true
            - name: GITHUB_ORG
              value: "topmate-io"
            # --- GitHub Webhooks ---
            - name: GITHUB_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: github-webhook-secret
                  optional: true
            # --- Vertex AI ---
            - name: GCP_PROJECT_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: gcp-project-id
                  optional: true
            - name: GCP_LOCATION
              value: "us-central1"
            # --- Anthropic (when switching to Claude API) ---
            # - name: ANTHROPIC_API_KEY
            #   valueFrom:
            #     secretKeyRef:
            #       name: topmate-bi-secrets
            #       key: anthropic-api-key
            #       optional: true
            # --- OpenAI (when switching to OpenAI) ---
            # - name: OPENAI_API_KEY
            #   valueFrom:
            #     secretKeyRef:
            #       name: topmate-bi-secrets
            #       key: openai-api-key
            #       optional: true
            # --- OpenRouter ---
            - name: OPENROUTER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: openrouter-api-key
                  optional: true
            # --- AWS Athena (WebEngage events) ---
            - name: WEBENGAGE_AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: webengage-aws-access-key-id
                  optional: true
            - name: WEBENGAGE_AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: webengage-aws-secret-access-key
                  optional: true
            - name: ATHENA_REGION
              value: "ap-south-1"
            - name: ATHENA_DATABASE
              value: "webengage-events"
            - name: ATHENA_WORKGROUP
              value: "webengage-sql"
            # --- AWS S3 ---
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: s3-bucket
                  optional: true
            - name: S3_REGION
              value: "ap-south-1"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: s3-aws-access-key-id
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: s3-aws-secret-access-key
                  optional: true
            # --- Redis (in-cluster) ---
            - name: REDIS_URL
              value: "redis://redis-service.postgres-mcp.svc:6379/0"
            # --- Security ---
            - name: ALLOWED_IPS
              valueFrom:
                configMapKeyRef:
                  name: postgres-mcp-allowlist
                  key: allowed-ips
            - name: AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: auth-token
                  optional: true
            # --- OAuth 2.1 (Claude.ai Custom Connector) ---
            - name: OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: oauth-client-id
                  optional: true
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: oauth-client-secret
                  optional: true
            - name: OAUTH_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: topmate-bi-secrets
                  key: oauth-jwt-secret
                  optional: true
            - name: OAUTH_ISSUER
              value: "https://mcp.gabbanext.run/db-mcp"
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 9000
            initialDelaySeconds: 45
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      terminationGracePeriodSeconds: 60
